# gz-git sync 명령어 재구성 (Option A)

## 목표

Source 중심의 일관성 있는 명령어 구조로 재설계하여 확장성과 사용성을 개선합니다.

## 현재 구조의 문제점

```bash
gz-git sync
├── forge     # "소스" 개념
└── run       # "실행 방식" 개념  ← 개념적 불일치!
```

**문제**:
1. `forge`는 "어디서", `run`은 "어떻게" - 서로 다른 차원
2. 새로운 소스 추가 시 일관성 없음
3. Config 생성 기능 없음
4. `forge` → config → `run` 워크플로우가 자연스럽지 않음

## 새로운 구조 (Option A)

```bash
gz-git sync
├── from-forge        # Git forge(GitHub/GitLab/Gitea)에서 직접 sync
├── from-config       # YAML config 파일에서 sync
├── from-scan         # 로컬 디렉토리 스캔 (미래 확장)
└── config            # Config 관리 서브명령어
    ├── generate      # Config 파일 생성
    ├── merge         # 기존 config에 추가
    ├── validate      # Config 파일 검증
    └── init          # 기본 샘플 생성
```

## 명령어 상세

### 1. `gz-git sync from-forge`

Git forge에서 **직접** repository들을 sync합니다.

```bash
gz-git sync from-forge \
  --provider gitlab \
  --org devbox \
  --target ~/repos \
  --base-url https://gitlab.polypia.net \
  --token $GITLAB_TOKEN \
  --clone-proto ssh
```

**주요 옵션**:
- `--provider`: github | gitlab | gitea
- `--org`: Organization/Group name
- `--target`: 로컬 디렉토리
- `--base-url`: API endpoint (self-hosted용)
- `--clone-proto`: ssh | https (기본: ssh)
- `--ssh-port`: SSH 포트 (선택, GitLab API 자동 감지)
- `--include-subgroups`: GitLab 하위 그룹 포함 (신규)
- `--subgroup-mode`: flat | nested (기본: flat)
- `--include-archived`: Archived repo 포함
- `--include-forks`: Fork repo 포함
- `--dry-run`: 미리보기

**GitLab Subgroup 처리**:

```bash
# Flat mode (기본): group-subgroup-repo 형태
gz-git sync from-forge \
  --provider gitlab \
  --org parent-group \
  --include-subgroups \
  --subgroup-mode flat
# 결과: ~/repos/parent-group-subgroup1-repo1
#       ~/repos/parent-group-subgroup2-repo2

# Nested mode: 디렉토리 계층 구조
gz-git sync from-forge \
  --provider gitlab \
  --org parent-group \
  --include-subgroups \
  --subgroup-mode nested
# 결과: ~/repos/parent-group/subgroup1/repo1
#       ~/repos/parent-group/subgroup2/repo2
```

### 2. `gz-git sync from-config`

YAML config 파일에서 repository들을 sync합니다.

```bash
gz-git sync from-config -c sync.yaml
gz-git sync from-config -c sync.yaml --dry-run
gz-git sync from-config -c sync.yaml --strategy pull
```

**주요 옵션**:
- `-c, --config`: Config 파일 경로 (필수)
- `--strategy`: 전체 override (reset | pull | fetch)
- `--parallel`: 병렬 처리 수 override
- `--dry-run`: 미리보기
- `--resume`: 중단된 sync 재개
- `--state-file`: State 파일 경로

### 3. `gz-git sync config generate`

Git forge에서 config 파일을 생성합니다.

```bash
# 기본 생성
gz-git sync config generate \
  --provider gitlab \
  --org devbox \
  --base-url https://gitlab.polypia.net \
  --token $GITLAB_TOKEN \
  --output sync.yaml

# 하위 그룹 포함
gz-git sync config generate \
  --provider gitlab \
  --org parent-group \
  --include-subgroups \
  --subgroup-mode flat \
  --output sync.yaml

# 기본 설정 포함
gz-git sync config generate \
  --provider gitlab \
  --org devbox \
  --output sync.yaml \
  --with-defaults  # strategy, parallel 등 기본값 포함
```

**생성되는 Config 형식**:

```yaml
# Generated by gz-git sync config generate
# Provider: gitlab
# Organization: devbox
# Generated at: 2026-01-16T10:30:00Z

strategy: reset
parallel: 4
maxRetries: 3
cleanupOrphans: false

# Clone protocol settings
cloneProto: ssh
sshPort: 0  # 0 = auto-detect from GitLab API

repositories:
  - name: repo1
    url: ssh://git@gitlab.polypia.net:2224/devbox/repo1.git
    targetPath: ~/repos/repo1
    provider: gitlab

  - name: repo2
    url: ssh://git@gitlab.polypia.net:2224/devbox/repo2.git
    targetPath: ~/repos/repo2
    provider: gitlab
```

### 4. `gz-git sync config scan`

**로컬 디렉토리를 스캔**하여 git repository를 발견하고 config 파일을 생성합니다.

```bash
# Unified: 단일 config 파일
gz-git sync config scan ~/mydevbox \
  --strategy unified \
  --output sync.yaml \
  --depth 2

# Per-directory: 계층별 config 파일
gz-git sync config scan ~/mydevbox \
  --strategy per-directory \
  --per-dir-name .gz-git-sync.yaml \
  --depth 3

# .gitignore 무시
gz-git sync config scan ~/mydevbox \
  --no-gitignore \
  --output sync.yaml

# 패턴 제외/포함
gz-git sync config scan ~/mydevbox \
  --exclude "vendor,node_modules,tmp/*" \
  --include "important-submodules/*" \
  --output sync.yaml
```

**스캔 전략**:
- `unified` (기본): 모든 repo를 하나의 config 파일에 저장
- `per-directory`: 각 디렉토리 레벨마다 config 파일 생성

**특징**:
- `.gitignore` 패턴 자동 존중 (disable: `--no-gitignore`)
- 중첩 repository 지원 (상위 + 하위 모두 포함)
- Multiple remote URL 처리 (`url` vs `urls` field)
- Empty remote 처리 (`url: ""`)

**생성되는 Config 형식**:

```yaml
# Generated: 2026-01-16T11:00:00+09:00
# Path: /home/user/mydevbox
# Strategy: unified
# Scanned: 19

strategy: reset
parallel: 4
maxRetries: 3
cloneProto: ssh
sshPort: 0

repositories:
  - name: gzh-cli-devbox
    url: ssh://git@gitlab.polypia.net:2224/devbox/gzh-cli-devbox.git
    targetPath: /home/user/mydevbox/gzh-cli-devbox

  - '# depth': 1
    name: gzh-cli
    url: git@github.com:Gizzahub/gzh-cli.git
    targetPath: /home/user/mydevbox/gzh-cli-devbox/gzh-cli

  # Multiple remotes
  - name: multi-origin-repo
    urls:
      - git@github.com:user/repo.git
      - git@gitlab.com:user/repo.git
    targetPath: /home/user/mydevbox/multi-origin-repo
```

### 5. `gz-git sync config init`

샘플 config 파일을 생성합니다.

```bash
gz-git sync config init -o sync.yaml
```

### 6. `gz-git sync config merge`

기존 config에 새로운 repository들을 **중복 없이** 추가합니다.

```bash
# 다른 org 추가
gz-git sync config merge \
  --provider gitlab \
  --org another-group \
  --base-url https://gitlab.polypia.net \
  --token $GITLAB_TOKEN \
  --into sync.yaml

# 덮어쓰기 (기본: 추가만)
gz-git sync config merge \
  --provider gitlab \
  --org devbox \
  --into sync.yaml \
  --mode overwrite  # append | overwrite | update
```

**Merge 모드**:
- `append` (기본): 중복 없이 추가만
- `overwrite`: 기존 파일 완전 교체
- `update`: 동일 repo는 업데이트, 없으면 추가

### 7. `gz-git sync config validate`

Config 파일을 검증합니다.

```bash
gz-git sync config validate -c sync.yaml
```

**검증 항목**:
- YAML 문법
- 필수 필드 (name, url, targetPath)
- targetPath 중복
- URL 형식
- Strategy 값

## 마이그레이션 계획

### Phase 1: 명령어 추가 (하위 호환 유지)

```bash
# 기존 (계속 동작)
gz-git sync forge ...
gz-git sync run ...

# 신규 (추가)
gz-git sync from-forge ...      # forge의 alias
gz-git sync from-config ...     # run의 alias
gz-git sync config generate ...
```

### Phase 2: Deprecation 경고

```bash
$ gz-git sync forge ...
Warning: 'sync forge' is deprecated, use 'sync from-forge' instead

$ gz-git sync run ...
Warning: 'sync run' is deprecated, use 'sync from-config' instead
```

### Phase 3: 제거 (Breaking Change)

```bash
# v3.0.0
gz-git sync forge ...     # Error: unknown command
gz-git sync run ...       # Error: unknown command
```

## Config 파일 형식 개선

### 새로운 필드 추가

```yaml
# Git clone settings (from sync from-forge)
cloneProto: ssh        # ssh | https
sshPort: 2224          # Custom SSH port (0 = auto)

# Provider info (for documentation)
provider: gitlab
organization: devbox
generatedAt: 2026-01-16T10:30:00Z

# GitLab subgroup settings
subgroupMode: flat     # flat | nested
includeSubgroups: true

repositories:
  - name: repo1
    url: ssh://git@gitlab.polypia.net:2224/devbox/repo1.git
    targetPath: ~/repos/repo1
    provider: gitlab
    cloneProto: ssh     # Per-repo override
```

## GitLab Subgroup 처리 상세

### API 호출 전략

```go
// List all projects in group (including subgroups)
opts := &gitlab.ListGroupProjectsOptions{
    IncludeSubGroups: gitlab.Ptr(true),
    PerPage:          100,
}
projects, _, err := client.Groups.ListGroupProjects(group, opts)
```

### Path 생성 로직

**Flat mode**:
```
Input:  parent-group/subgroup1/repo1
Output: ~/repos/parent-group-subgroup1-repo1
```

**Nested mode**:
```
Input:  parent-group/subgroup1/repo1
Output: ~/repos/parent-group/subgroup1/repo1
```

**구현**:

```go
func buildTargetPath(basePath, projectPath string, mode SubgroupMode) string {
    switch mode {
    case SubgroupModeFlat:
        // Replace / with -
        flat := strings.ReplaceAll(projectPath, "/", "-")
        return filepath.Join(basePath, flat)

    case SubgroupModeNested:
        // Keep directory structure
        return filepath.Join(basePath, projectPath)

    default:
        return filepath.Join(basePath, projectPath)
    }
}
```

## 구현 우선순위

### Phase 1: 명령어 재구성 (주)
1. ✅ `sync from-forge` (forge 복사 + alias)
2. ✅ `sync from-config` (run 복사 + alias)
3. ⏳ Deprecation 경고 추가

### Phase 2: Config 관리 (중요)
4. ⏳ `sync config init` (샘플 생성)
5. ⏳ `sync config generate` (forge → config)
6. ⏳ `sync config merge` (config 병합)
7. ⏳ `sync config validate` (검증)

### Phase 3: GitLab 고급 기능 (부가)
8. ⏳ `--include-subgroups` 지원
9. ⏳ `--subgroup-mode` (flat | nested)
10. ⏳ Config 파일에 subgroup 정보 포함

### Phase 4: 정리
11. ⏳ 문서 업데이트
12. ⏳ 마이그레이션 가이드
13. ⏳ Breaking change (v3.0)

## 예상 사용 시나리오

### Scenario 1: GitLab org 전체 빠르게 sync

```bash
# 한 번에 실행
gz-git sync from-forge \
  --provider gitlab \
  --org devbox \
  --target ~/projects
```

### Scenario 2: Config 기반 관리

```bash
# 1. Config 생성
gz-git sync config generate \
  --provider gitlab \
  --org devbox \
  --output ~/.config/gz-git/sync.yaml

# 2. Config 확인/수정
vi ~/.config/gz-git/sync.yaml

# 3. Sync 실행
gz-git sync from-config -c ~/.config/gz-git/sync.yaml

# 4. 다른 org 추가
gz-git sync config merge \
  --provider gitlab \
  --org another-group \
  --into ~/.config/gz-git/sync.yaml

# 5. 다시 sync
gz-git sync from-config -c ~/.config/gz-git/sync.yaml
```

### Scenario 3: GitLab 복잡한 그룹 구조

```bash
# 하위 그룹 포함, nested 구조
gz-git sync from-forge \
  --provider gitlab \
  --org platform \
  --include-subgroups \
  --subgroup-mode nested \
  --target ~/work

# 결과:
# ~/work/platform/backend/api
# ~/work/platform/backend/worker
# ~/work/platform/frontend/web
# ~/work/platform/frontend/mobile
```

---

**Version**: 2.0 → 3.0 (Breaking)
**Status**: Design Complete, Ready for Implementation
**Date**: 2026-01-16
